var arrLinksToCheck=[];var strTld;var strAffiliateId;function linkAmazon(objLink,strAsin){this.objLink=objLink;if(strAsin){this.strAsin=strAsin}this.affiliateLink=function(){this.objLink.href="http://www.amazon."+this.getActualTld()+"/exec/obidos/ASIN/"+this.strAsin+"/"+getAffiliateId(arrTldActual[1])};this.searchLink=function(){var objRegexTitle=new RegExp("amazon.[a-zA-Z.]{2,5}/([A-Za-z-]*)/dp");arrResult=objRegexTitle.exec(this.objLink.href);if(arrResult){strTitle=arrResult[1].replace(/-/g,"%20");this.writeSearchLink(strTitle)}else{strUrlProduct=strUrlAjax+"?strAction=search&strLink="+this.objLink.href;objScript=document.createElement("script");objScript.src=strUrlProduct;document.getElementsByTagName("head")[0].appendChild(objScript)}};this.writeSearchLink=function(strTitle){this.objLink.href="http://www.amazon."+strTld+"/s?keywords="+strTitle+"&tag="+strAffiliateId};this.getAffiliateUrl=function(){return"http://www.amazon."+strTld+"/exec/obidos/ASIN/"+this.strAsin+"/"+strAffiliateId};this.localiseLink=function(){this.objLink.href=this.getAffiliateUrl()};this.getActualTld=function(){var c=new RegExp("amazon.(.*?)/");arrTldActual=c.exec(this.objLink.href);return arrTldActual[1]}}function checkAmazonLinks(){var objRegexAsin=new RegExp("/([A-Z0-9]{10})");if(typeof google!="undefined"&&google.loader.ClientLocation!=null){var strCountry=google.loader.ClientLocation.address.country_code;switch(strCountry){case'GB':case'IE':strTld='co.uk';break;case'AT':strTld='de';default:strTld=(arrAffiliates[strCountry.toLowerCase()]?strCountry.toLowerCase():'com');break}strAffiliateId=getAffiliateId(strTld)}var arrLinks=document.getElementsByTagName("a");for(i=0,j=arrLinks.length;i<j;i++){var intIndex=arrLinks[i].href.toLowerCase().indexOf("amazon.");if(intIndex>0&&intIndex<arrLinks[i].href.substring(8).indexOf("/")+8){var arrResults=objRegexAsin.exec(arrLinks[i].href);if(arrResults){objLink=new linkAmazon(arrLinks[i],arrResults[1]);if(strTld&&strTld!=objLink.getActualTld()){arrLinksToCheck[arrResults[1]]=objLink}else{objLink.affiliateLink()}}else{var intPreTag=arrLinks[i].href.indexOf("tag=");if(!strTld){objLink=new linkAmazon(arrLinks[i]);strTldChecked=objLink.getActualTld()}else{strTldChecked=strTld}if(intPreTag>0){intPreTag+=4;var intPostTag=arrLinks[i].href.substring(intPreTag).indexOf("&");if(intPostTag<0){intPostTag=arrLinks[i].href.length-intPreTag}arrLinks[i].href=arrLinks[i].href.substring(0,intPreTag)+getAffiliateId(strTldChecked)+arrLinks[i].href.substring((intPostTag+intPreTag));intPath=arrLinks[i].href.indexOf("/",arrLinks[i].href.indexOf("amazon"));arrLinks[i].href="http://www.amazon."+strTldChecked+arrLinks[i].href.substring(intPath)}else{intPath=arrLinks[i].href.indexOf("/",arrLinks[i].href.indexOf("amazon"));arrLinks[i].href=arrLinks[i].href.substring(0,arrLinks[i].href.indexOf("amazon."))+"amazon."+strTldChecked+arrLinks[i].href.substring(intPath)+(arrLinks[i].href.indexOf("?")>0?"&":"?")+"tag="+getAffiliateId(strTldChecked)}}}}var strLinksToCheck="";for(strKey in arrLinksToCheck){strLinksToCheck+=arrLinksToCheck[strKey].strAsin+"|"}if(strLinksToCheck.length){var strUrlAjaxLinks=strUrlAjax+"?strTld="+strTld+"&strAffiliateId="+strAffiliateId+"&strLinks="+strLinksToCheck;strUrlAjaxLinks=strUrlAjaxLinks.substring(0,strUrlAjaxLinks.length-1);objScript=document.createElement("script");objScript.src=strUrlAjaxLinks;document.getElementsByTagName("head")[0].appendChild(objScript)}}function getAffiliateId(strTLD){return(arrAffiliates[strTLD]?arrAffiliates[strTLD]:arrAffiliatesSpares[strTLD])}if(window.addEventListener){window.addEventListener("load",checkAmazonLinks,false)}else{window.attachEvent("onload",checkAmazonLinks)}var arrAffiliatesSpares={'co.uk':'pcrev05','com':'petewill-20','de':'petewill05-21','fr':'petewill-21','ca':'petewill00-20','co.jp':'petewill-22','jp':'petewill-22','it':'petewill04-21','cn':'petewill-23'};